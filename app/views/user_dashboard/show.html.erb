<h2 class="text-center mt-4">Getting Started</h2>

<p class="text-center mb-4">
  This is your basic information. Handle your banking information and your profile here.
</p>

<div class="card-deck text-center">
  <div class="card <%= plaid_card_class %>">
    <div class="card-body">
      <h4>
        Banking
      </h4>
      <p>
      <i class="fa fa-bank fa-3x text-primary"></i>
      </p>
      <p>
      <% if @user.needs_to_sign_up_for_plaid? %>
        You need to add your bank account here in order to pay rent for the month. :)
      <% else %>
        <ul class="list-group list-group-flush">
          <li class="list-group-item bg-transparent">
            <strong class="pull-left"> Bank Name: </strong>
            <span class="pull-right">
              <%= @user.bank_account_name %>
            </span>
          </li>
          <li class="list-group-item bg-transparent">
            <strong class="pull-left">Account:</strong>
            <span class="pull-right">
              ...<%= @user.bank_account_last4 %>
            </span>
          </li>
        </ul>
      <% end %>
      </p>
    </div>
    <div class="card-footer">
      <%= link_to('') do %>
        <div class="card-link font-weight-bold" id="linkButton">
          <%= plaid_card_link_text %>
        </div>
      <% end %>
      <form id="ach_form" method="post" action="/tenant_plaid_accounts">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      </form>
    </div>
  </div>
  <div class="card">
    <div class="card-body">
      <h4>
        Your Lease
      </h4>
      <p>
      <i class="fa fa-newspaper-o fa-3x text-primary"></i>
      </p>
    </div>
    <div class="card-footer">
      <%= link_to(user_lease_path(current_user.current_lease)) do %>
        <div class="card-link font-weight-bold">
          View Lease Details
        </div>
      <% end %>
    </div>
  </div>
  <div class="card <%= lease_payment_style.card_class %>">
    <div class="card-body">
      <h4>
        Pay Rent
      </h4>
      <p>
      <i class="fa fa-money fa-3x text-primary"></i>
      </p>
      <% if @lease_payment %>
        <strong>
          Current Owed:
        </strong>
        <p>
        <%= number_to_currency(@user.current_human_amount_owed) %>
        </p>
        <p>
        due in <%= pluralize(@lease_payment.due_in_days, 'day') %>
        </p>
      <% end %>
    </div>
    <div class="card-footer">
      <%= link_to new_payment_path, class: lease_payment_style.card_class do %>
        <div class="card-link font-weight-bold">
          <%= lease_payment_style.button_text %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% if @user.residencies.present? %>

  <h2 class="text-center mt-4">Your Residence</h2>

  <p class="text-center">
  This is your home! Here is some information about it
  </p>

  <div class="card">
    <div class="card-body row">
      <div class="col-6">
        <h2>Address Information</h2>
        <p>
        <strong>Address city:</strong>
        <%= @property.address_city %>
        </p>
        <p>
        <strong>Address line1:</strong>
        <%= @property.address_line1 %>
        </p>
        <p>
        <strong>Address state:</strong>
        <%= @property.address_state %>
        </p>
        <p>
        <strong>Address postal:</strong>
        <%= @property.address_postal %>
        </p>
        <p>
        <strong>Name:</strong>
        <%= @property.name %>
        </p>
        <p>
        <strong>Description:</strong>
        <%= @property.description %>
        </p>
      </div>

      <div class="col-6">
        <% if @property.property_images.present? %>
          <div id="carouselControls" class="carousel slide" data-ride="carousel">
            <div class="carousel-inner bg-dark text-center">
              <% @property.property_images.each_with_index do |image, index| %>
                <div class="carousel-item <%= 'active' if index == 0 %>">
                  <%= image_tag image.image.url, class: 'd-block', style: 'margin: 0 auto;max-height: 400px; width: 100%' %>
                </div>
              <% end %>
            </div>
            <a class="carousel-control-prev" href="#carouselControls" role="button" data-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#carouselControls" role="button" data-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
  var linkHandler = Plaid.create({
    env: "<%= ENV['PLAID_ENV'] %>",
    clientName: 'LordCore',
    apiVersion: 'v2',
    selectAccount: true,
    key: "<%= ENV['PLAID_PUBLIC_KEY'] %>",
    product: 'auth',
    onSuccess: function(public_token, metadata) {
      // Disable the connect button
      $('#linkButton').prop('disabled', true).html("<i class='fa fa-spinner fa-spin'></i> Connecting your account...");
      // Append the public_token and account_id to the form
      $('#ach_form').append($('<input type="hidden" name="public_token" />').val(public_token));
      $('#ach_form').append($('<input type="hidden" name="account_id" />').val(metadata.account_id));

      // Submit the form
      $('#ach_form').submit();
    },
  });

  // Trigger the Link UI
  document.getElementById('linkButton').onclick = function(event) {
    event.preventDefault();
    linkHandler.open();
  };
</script>
