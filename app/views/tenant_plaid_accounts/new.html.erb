<div class="container">
  <div class="row">
    <div class="col-md-12 topspace text-center">
      <h1 class="page-header">
        Log in to connect your bank account with Plaid
      </h1>
      <button class="btn btn-custom btn-lg btn-primary" id='linkButton'>
        <span class="fa fa-bank"></span> Connect your bank account
      </button>
      <div class="topspace text-muted">
        <strong>Hint:</strong> The test credentials for Plaid can be found <a href="https://plaid.com/docs/api/#sandbox">in the Plaid docs</a>.
      </div>
      <form id="ach_form" method="post" action="/tenant_plaid_accounts">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      </form>
      <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
      <script>
        var linkHandler = Plaid.create({
          env: "<%= ENV['PLAID_ENV'] %>",
          clientName: 'LordCore',
          apiVersion: 'v2',
          selectAccount: true,
          key: "<%= ENV['PLAID_PUBLIC_KEY'] %>",
          product: 'auth',
          onSuccess: function(public_token, metadata) {
            // Disable the connect button
            $('#linkButton').prop('disabled', true).html("<i class='fa fa-spinner fa-spin'></i> Connecting your account...");
            // Append the public_token and account_id to the form
            $('#ach_form').append($('<input type="hidden" name="public_token" />').val(public_token));
            $('#ach_form').append($('<input type="hidden" name="account_id" />').val(metadata.account_id));

            // Submit the form
            $('#ach_form').submit();
          },
        });

        // Trigger the Link UI
        document.getElementById('linkButton').onclick = function() {
          linkHandler.open();
        };
      </script>
    </div>
  </div>
</div>

